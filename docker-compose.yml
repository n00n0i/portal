services:
  portal:
    image: node:22-alpine
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host --port 3000"
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
    env_file:
      - .env.local
    environment:
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-portal}
      - MYSQL_USER=${MYSQL_USER:-portal}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-portalpass}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpass}
      - API_BASE_URL=${API_BASE_URL:-http://api:4000}
    depends_on:
      - mysql
      - api

  api:
    image: node:22-alpine
    working_dir: /app
    command: sh -c "npm install && npm run server:build && npm run server:start"
    ports:
      - "${API_PORT:-4000}:4000"
    volumes:
      - .:/app
      - /app/node_modules
    env_file:
      - .env.local
    environment:
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-portal}
      - MYSQL_USER=${MYSQL_USER:-portal}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-portalpass}
      - SMTP_HOST=${SMTP_HOST:-maildev}
      - SMTP_PORT=${SMTP_PORT:-1025}
      - SMTP_SECURE=${SMTP_SECURE:-false}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-portal@example.com}
      - API_PORT=${API_PORT:-4000}
      - API_PUBLIC_URL=${API_PUBLIC_URL:-http://localhost:4000}
    depends_on:
      - mysql
      - maildev

  mysql:
    image: n00n0i/portal-mysql:latest
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-portal}
      MYSQL_USER: ${MYSQL_USER:-portal}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-portalpass}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -p${MYSQL_ROOT_PASSWORD:-rootpass} --silent"]
      interval: 10s
      timeout: 5s
      retries: 5

  maildev:
    image: maildev/maildev:2.1.0
    ports:
      - "1080:1080"   # Web UI
      - "1025:1025"   # SMTP
    restart: unless-stopped

volumes:
  mysql_data:
